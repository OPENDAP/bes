#!/bin/sh

location=@prefix@
if [ "$location" == "NONE" ]
then
    location=/usr/local
fi

if [ ! -f ${location}/sbin/besd ]
then
    echo "BES does not appear to be installed in ${location}"
    exit 1
fi
echo "BES install directory: ${location}"

what=$1
shift

case $what in
stop)
    if [ ! -f "${location}"/run/bes.pid ]
    then
	echo "The BES daemon is not currently running"
	exit 1
    fi
    echo "Shutting down the BES daemon"
    (cat "$location"/run/bes.pid | cut -d' ' -f2 | xargs kill -INT) 2> /dev/null
    ;;
start)
    if [ -f "${location}"/run/bes.pid ]
    then
	echo "The BES daemon is already running"
	cat "${location}"/run/bes.pid
	exit 1
    fi
    echo "Starting the BES daemon"
    "${location}"/sbin/besd $*
    sleep 5
    if [ -f "${location}"/run/bes.pid ]
    then
	cat "${location}"/run/bes.pid
    else
	echo "The BES daemon did not appear to start"
    fi
    ;;
restart)
    if [ ! -f "${location}"/run/bes.pid ]
    then
	echo "The BES daemon is not currently running"
	exit 1
    fi
    echo "Shutting down the BES daemon"
    (cat "${location}"/run/bes.pid | cut -d' ' -f2 | xargs kill -INT) 2> /dev/null
    sleep 5
    if [ -f ${location}/run/bes.pid ]
    then
	echo "Unable to stop the BES daemon"
	exit 1
    fi
    echo "Starting the BES daemon"
    "${location}"/sbin/besd $*
    sleep 5
    if [ -f "${location}"/run/bes.pid ]
    then
	cat "${location}"/run/bes.pid
    else
	echo "The BES daemon did not appear to start"
    fi
    ;;
status)
    if [ ! -f "${location}"/run/bes.pid ]
    then
	echo "The BES daemon is not currently running"
	exit 1
    fi
    echo "The BES daemon is currently running"
    cat "${location}"/run/bes.pid
    ;;
config)
    conf=${BES_CONF}
    if [ ! -f "${conf}" ]
    then
	conf=${location}/etc/bes/bes.conf
	if [ ! -f "${conf}" ]
	then
	    echo "The BES configuration file cannot be located at ${conf}"
	    exit 1
	fi
    fi
    cat "${conf}"
    ;;
*)
    echo "USAGE: besctl (start|stop|restart|status|config)"
    exit 1
    ;;
esac

