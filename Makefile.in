
# Makefile for hdf-dods.
#
# $Id: Makefile.in,v 1.38 2005/03/16 21:00:20 jimg Exp $

@SET_MAKE@

PROGS = hdf_handler libhdf-dods.a libhdf-server4.a

DODS_ROOT = @dods_relative@

INCS = -I. -I.. -Ihdfclass @INCS@ 
DEFS = @DEFS@
CPPFLAGS = @CPPFLAGS@ $(DEFS) $(INCS)
CXXFLAGS_DEBUG = -g3 -O0 -Wall -fno-default-inline -fno-defer-pop
# CXXPROF = -pg --profile-arcs
CXXFLAGS = @CXXFLAGS@ -Wall $(CXXPROF)
# LDPROF = -pg
LDFLAGS = @LDFLAGS@ -L. -Lhdfclass $(LDPROF)
LFLAGS = -8
YFLAGS = -d -v
LIBS = -lhdf-dods -ldap++ -lhdf-dods -ldap++ -lhdfclass @LIBS@

# Set the installation directories; prefix can be set on the command line
# during Makefile construction with `./configure --prefix /my/choice'

prefix = @prefix@
exec_prefix = $(prefix)
bindir = $(exec_prefix)bin
libdir = $(exec_prefix)lib
includedir = $(prefix)include
manext = 1
mandir = $(prefix)man/man$(manext)

src = $(DODS_ROOT)src
etcdir = $(DODS_ROOT)etc

INSTALLMAN = man

SHELL = /bin/sh
srcdir = @srcdir@
version = @VERSION@
basedir = hdf-dods
dir = $(basedir)-$(version)
host = @host@

COMPONENT_NAME = DODS HDF Server

# testsuite specifics
RUNTEST = runtest
RUNTESTFLAGS = #--all --verbose
TESTDIR = @testurl@

# names of key programs

LN_S = @LN_S@
CP = cp
AWK = @AWK@
PERL = @PERL@
TAR = @TAR@
CXX = @CXX@
YACC = @YACC@
LEX = @LEX@
AR = ar
TAGS = etags
RANLIB = @RANLIB@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
STRIP = strip

#vpath %.h src
#vpath %.cc src

HDFOBJS = HDFArray.o HDFByte.o HDFFloat64.o HDFGrid.o \
	  HDFInt32.o HDFUInt32.o HDFSequence.o HDFStr.o \
	  HDFStructure.o HDFUrl.o hdfdesc.o hc2dap.o dhdferr.o \
	  hdfutil.o hdfeos.tab.o lex.hdfeos.o HDFInt16.o \
	  HDFUInt16.o HDFFloat32.o

SRVOBJS = hdf_handler.o funcs.o

all:	HDFClass $(PROGS)

HDFClass:
	cd ./hdfclass; $(MAKE) $(MFLAGS)

# Build the HDF-EOS parser

hdfeos.tab.c hdfeos.tab.h: hdfeos.y
	$(YACC) $(YFLAGS) -p hdfeos hdfeos.y

hdfeos.tab.o: hdfeos.tab.c	# build using C++ compiler
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -c hdfeos.tab.c -o hdfeos.tab.o

# Build the HDF-EOS scanner

lex.hdfeos.c: hdfeos.lex hdfeos.tab.c hdfeos.tab.h
	$(LEX) $(LFLAGS) -Phdfeos hdfeos.lex
#	rm hdfeos.lex

lex.hdfeos.o: lex.hdfeos.c
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -c lex.hdfeos.c -o lex.hdfeos.o

eosdas-test: eosdas-test.o lex.hdfeos.o hdfeos.tab.o libhdf-dods.a HDFClass
	$(CXX) -o eosdas-test eosdas-test.o $(LDFLAGS) $(LIBS)

libhdf-dods.a:	$(HDFOBJS)
	ar ru libhdf-dods.a $(HDFOBJS)

libhdf-server4.a: $(HDFOBJS) HDFRequestHandler.o
	$(AR) -cru $@ $^
	$(RANLIB) $@

hdf_handler: $(SRVOBJS) libhdf-dods.a hdfclass/libhdfclass.a
	$(CXX) $(SRVOBJS) -o hdf_handler $(LDFLAGS) $(LIBS)

srvtest: srvtest.o libhdf-dods.a
	$(CXX) srvtest.o -o srvtest $(LDFLAGS) $(LIBS)

escfilt: escfilt.o libhdf-dods.a
	$(CXX) escfilt.o -o escfilt $(LDFLAGS) $(LIBS)

clean:
	-rm *.o $(PROGS) core eosdas-test *~
	-cd hdfclass && $(MAKE) $(MFLAGS) clean

distclean: clean
	-rm config.*

install: all
	$(INSTALL_PROGRAM) -s ./hdf_handler $(etcdir)

configure: configure.in $(DODS_ROOT)etc/aclocal.m4
	autoconf --localdir=$(DODS_ROOT)etc

Makefile: Makefile.in
	if [ -x ./config.status ]; \
	then \
	    ${SHELL} ./config.status; \
	else \
	    ./configure; \
	fi

check:
	${RUNTEST} ${RUNTESTFLAGS} --tool geturl --srcdir hdf-testsuite

# Bad
#  	rootme=`pwd` && export rootme && export TESTDIR="$(TESTDIR)" && \

.SUFFIXES:      .o .cc .c

.c.o:
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -o $@ $<

.cc.o:
	$(CXX) -c $(CXXFLAGS) $(CPPFLAGS) -o $@ $<

.PHONY: depend
depend: 
	@echo "Build the dependencies by hand or use depend.sh and edit to"
	@echo "remove any mention of the hdf system headers."


# This is a special tar target because it builds not only the tar file for
# the core software but also the lib, etc, and bin directories. It assumes
# that the root directory for DODS is called `DODS' (no version number).
.PHONY: tar
tar:
	-rm -r config.cache config.log config.status
	cd $(DODS_ROOT)/.. && \
	$(TAR) --exclude 'old' --exclude '.#*' --exclude 'CVS' \
	    --exclude '.flc' --exclude 'Makefile' \
            --gzip --create --dereference \
	    --file DODS-$(dir).tar.gz DODS/src/$(dir)

# Creates tar files for binary distributions.
#
.PHONY: binary-tar
binary-tar:
	cd $(DODS_ROOT).. && \
	$(TAR) --gzip --create \
	    --file DODS-hdf-server-$(version)-$(host).tar.gz \
            DODS/NEWS \
            DODS/docs/README DODS/docs/README-hdf-server \
	    DODS/etc/hdf_handler

.PHONY: update-version
update-version: check-version
	@echo "Version is: `cat version.h`"
	if test ! -d ../$(dir); then mv ../$(basedir)* ../$(dir); fi
	if test ! -f $(DODS_ROOT)VERSION; then touch $(DODS_ROOT)VERSION; fi
	$(etcdir)/update-manifest.pl "$(COMPONENT_NAME)" $(version) \
		< $(DODS_ROOT)VERSION > tmp.dods.manifest
	mv tmp.dods.manifest $(DODS_ROOT)VERSION

# Compare the version encoded in this Makefile (set by configure) with the
# version in version.h. The version make variable is set up near the top of
# the Makefile.
.PHONY: check-version
check-version:
	@echo "Checking for version.h and Makefile version match-up"
	@if [ "$(version)" != "`cat version.h`" ]; \
	then \
		echo "You must manually re-run configure!"; \
		exit 1; \
	else \
		echo "Yes, they match."; \
	fi

.PHONY: tags
tags:
	(cd hdfclass && $(MAKE) $(MFLAGS) tags)
	$(TAGS) $(TAGS_FLAGS) --include=hdfclass/TAGS *.cc *.h 

# DO NOT DELETE; depend depends on this line.
dhdferr.o: dhdferr.cc config_hdf.h hdfclass/hcerr.h dhdferr.h
eosdas-test.o: eosdas-test.cc config_hdf.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/GetOpt.h \
  ../../include/DAS.h ../../include/Pix.h ../../include/AttrTable.h \
  ../../include/Error.h ../../include/DODSResponseObject.h \
  ../../include/parser.h ../../include/GSEClause.h \
  ../../include/BaseType.h ../../include/InternalErr.h \
  ../../include/dods-datatypes.h ../../include/Array.h \
  ../../include/dods-limits.h ../../include/Vector.h ../../include/DDS.h \
  ../../include/Constructor.h ../../include/Clause.h ../../include/expr.h \
  ../../include/RValue.h ../../include/Grid.h hdfeos.tab.h
funcs.o: funcs.cc config_hdf.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/Error.h \
  ../../include/InternalErr.h ../../include/dods-datatypes.h ./HDFArray.h \
  ../../include/Array.h ../../include/dods-limits.h \
  ../../include/Vector.h ../../include/DDS.h ../../include/Constructor.h \
  ../../include/DAS.h ../../include/DODSResponseObject.h \
  ../../include/Clause.h ../../include/expr.h ../../include/RValue.h \
  ./ReadTagRef.h ../../include/DDS.h
hc2dap.o: hc2dap.cc config_hdf.h hdfclass/hdfclass.h \
  hdfclass/hcstream.h hdfclass/hcerr.h ../../include/escaping.h \
  HDFInt32.h ../../include/Int32.h ../../include/dods-datatypes.h \
  ../../include/BaseType.h ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/Error.h \
  ../../include/InternalErr.h HDFInt16.h ../../include/Int16.h \
  HDFUInt32.h ../../include/UInt32.h HDFUInt16.h ../../include/UInt16.h \
  HDFFloat64.h ../../include/Float64.h HDFFloat32.h \
  ../../include/Float32.h HDFByte.h ../../include/Byte.h HDFStr.h \
  ../../include/dods-limits.h ../../include/Str.h \
  ../../include/dods-limits.h HDFArray.h ../../include/Array.h \
  ../../include/Vector.h ../../include/DDS.h ../../include/Constructor.h \
  ../../include/DAS.h ../../include/DODSResponseObject.h \
  ../../include/Clause.h ../../include/expr.h ../../include/RValue.h \
  ReadTagRef.h  HDFGrid.h \
  ../../include/Grid.h HDFSequence.h ../../include/Sequence.h \
  HDFStructure.h ../../include/Structure.h hdfutil.h dhdferr.h hdf-maps.h \
  ../../include/debug.h
HDFArray.o: HDFArray.cc config_hdf.h hdfclass/hdfclass.h \
  hdfclass/hcstream.h hdfclass/hcerr.h ../../include/escaping.h \
  HDFArray.h ../../include/Array.h ../../include/dods-limits.h \
  ../../include/Vector.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/Error.h \
  ../../include/InternalErr.h ../../include/dods-datatypes.h \
  ../../include/DDS.h ../../include/Constructor.h ../../include/DAS.h \
  ../../include/DODSResponseObject.h ../../include/Clause.h \
  ../../include/expr.h ../../include/RValue.h ReadTagRef.h \
   dhdferr.h ../../include/Error.h
HDFByte.o: HDFByte.cc config_hdf.h ../../include/InternalErr.h \
  ../../include/Error.h HDFByte.h ../../include/Byte.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
hdfdesc.o: hdfdesc.cc config_hdf.h hdfclass/hcstream.h \
  hdfclass/hcerr.h hdfclass/hdfclass.h ../../include/DDS.h \
  ../../include/Pix.h ../../include/IteratorAdapter.h \
  ../../include/BaseType.h ../../include/AttrTable.h \
  ../../include/Error.h ../../include/InternalErr.h \
  ../../include/dods-datatypes.h ../../include/Constructor.h \
  ../../include/DAS.h ../../include/DODSResponseObject.h \
  ../../include/Clause.h ../../include/expr.h ../../include/RValue.h \
  ../../include/DAS.h ../../include/escaping.h ../../include/debug.h \
  dhdferr.h HDFArray.h ../../include/Array.h ../../include/dods-limits.h \
  ../../include/Vector.h ReadTagRef.h  \
  HDFSequence.h ../../include/Sequence.h HDFGrid.h ../../include/Grid.h \
  dodsutil.h HDFStructure.h ../../include/Structure.h hdf-dods.h \
  hdf-maps.h ../../include/parser.h ../../include/GSEClause.h
HDFFloat32.o: HDFFloat32.cc config_hdf.h ../../include/InternalErr.h \
  ../../include/Error.h HDFFloat32.h ../../include/Float32.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDFFloat64.o: HDFFloat64.cc config_hdf.h ../../include/InternalErr.h \
  ../../include/Error.h HDFFloat64.h ../../include/Float64.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDFGrid.o: HDFGrid.cc config_hdf.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h  hdfclass/hdfclass.h \
  hdfclass/hcstream.h hdfclass/hcerr.h ../../include/escaping.h HDFGrid.h \
  ../../include/Grid.h ../../include/Pix.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Error.h \
  ../../include/InternalErr.h ../../include/dods-datatypes.h \
  ../../include/Constructor.h ReadTagRef.h  \
  HDFArray.h ../../include/Array.h ../../include/dods-limits.h \
  ../../include/Vector.h ../../include/DDS.h ../../include/DAS.h \
  ../../include/DODSResponseObject.h ../../include/Clause.h \
  ../../include/expr.h ../../include/RValue.h hdfutil.h dhdferr.h \
  ../../include/Error.h
hdf_handler.o: hdf_handler.cc config_hdf.h ../../include/DODSFilter.h \
  ../../include/DAS.h ../../include/Pix.h ../../include/IteratorAdapter.h \
  ../../include/AttrTable.h ../../include/Error.h \
  ../../include/DODSResponseObject.h ../../include/DDS.h \
  ../../include/BaseType.h ../../include/InternalErr.h \
  ../../include/dods-datatypes.h ../../include/Constructor.h \
  ../../include/Clause.h ../../include/expr.h ../../include/RValue.h \
  ../../include/DAS.h ../../include/DDS.h ../../include/DataDDS.h \
  ../../include/debug.h ../../include/cgi_util.h \
  ../../include/ObjectType.h ../../include/EncodingType.h \
  ../../include/ObjectType.h hdfclass/hcerr.h dhdferr.h hdfclass/hcerr.h
HDFInt16.o: HDFInt16.cc config_hdf.h ../../include/InternalErr.h \
  ../../include/Error.h HDFInt16.h ../../include/Int16.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDFInt32.o: HDFInt32.cc config_hdf.h ../../include/InternalErr.h \
  ../../include/Error.h HDFInt32.h ../../include/Int32.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
hdf_module.o: hdf_module.cc ../../include/DODSInitList.h \
  ../../include/DODSGlobalInit.h ../../include/DODSInitializer.h \
  ../../include/DODSInitFuns.h ../../include/TheRequestHandlerList.h \
  ../../include/DODSRequestHandlerList.h \
  ../../include/DODSDataHandlerInterface.h ../../include/DODSContainer.h \
  HDFRequestHandler.h ../../include/DODSRequestHandler.h \
  ../../include/TheDODSLog.h ../../include/DODSLog.h
HDFRequestHandler.o: HDFRequestHandler.cc ../../include/DAS.h \
  ../../include/Pix.h ../../include/IteratorAdapter.h \
  ../../include/AttrTable.h ../../include/Error.h \
  ../../include/DODSResponseObject.h ../../include/DDS.h \
  ../../include/BaseType.h ../../include/InternalErr.h \
  ../../include/dods-datatypes.h ../../include/Constructor.h \
  ../../include/Clause.h ../../include/expr.h ../../include/RValue.h \
  HDFRequestHandler.h ../../include/DODSRequestHandler.h \
  ../../include/DODSDataHandlerInterface.h ../../include/DODSContainer.h \
  ../../include/DODSResponseHandler.h ../../include/DODSTransmitter.h \
  ../../include/DODSResponseNames.h ../../include/DODSConstraintFuncs.h \
  ../../include/DODSInfo.h ../../include/cgi_util.h \
  ../../include/ObjectType.h ../../include/EncodingType.h \
  ../../include/TheDODSKeys.h ../../include/DODSKeys.h \
  ../../include/DODSResponseException.h \
  ../../include/DODSBasicException.h ../../include/DODSException.h
HDFSequence.o: HDFSequence.cc config_hdf.h hdfclass/hdfclass.h \
  hdfclass/hcstream.h hdfclass/hcerr.h HDFSequence.h \
  ../../include/Sequence.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Error.h \
  ../../include/InternalErr.h ../../include/dods-datatypes.h \
  ../../include/Constructor.h ReadTagRef.h  \
  HDFStructure.h ../../include/Structure.h ../../include/DDS.h \
  ../../include/DAS.h ../../include/DODSResponseObject.h \
  ../../include/Clause.h ../../include/expr.h ../../include/RValue.h \
  dhdferr.h ../../include/escaping.h ../../include/Error.h
HDFStr.o: HDFStr.cc config_hdf.h ../../include/InternalErr.h \
  ../../include/Error.h HDFStr.h ../../include/dods-limits.h \
  ../../include/Str.h ../../include/dods-limits.h \
  ../../include/BaseType.h ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/dods-datatypes.h
HDFStructure.o: HDFStructure.cc config_hdf.h \
  hdfclass/hdfclass.h hdfclass/hcstream.h hdfclass/hcerr.h \
  ../../include/Error.h ../../include/escaping.h HDFStructure.h \
  ../../include/Structure.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/InternalErr.h \
  ../../include/dods-datatypes.h ../../include/Constructor.h \
  ../../include/DDS.h ../../include/DAS.h \
  ../../include/DODSResponseObject.h ../../include/Clause.h \
  ../../include/expr.h ../../include/RValue.h ReadTagRef.h \
   ../../include/Sequence.h dhdferr.h
HDFUInt16.o: HDFUInt16.cc config_hdf.h ../../include/InternalErr.h \
  ../../include/Error.h HDFUInt16.h ../../include/UInt16.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDFUInt32.o: HDFUInt32.cc config_hdf.h ../../include/InternalErr.h \
  ../../include/Error.h HDFUInt32.h ../../include/UInt32.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDFUrl.o: HDFUrl.cc config_hdf.h ../../include/InternalErr.h \
  ../../include/Error.h HDFUrl.h ../../include/Url.h \
  ../../include/dods-limits.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/dods-datatypes.h \
  ../../include/Str.h
hdfutil.o: hdfutil.cc config_hdf.h hdfclass/hdfclass.h hdfutil.h \
  dhdferr.h hdfclass/hcerr.h
