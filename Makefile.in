
# $Id: Makefile.in,v 1.6 2004/02/05 00:55:43 jimg Exp $

@SET_MAKE@

# Set makefile variables, some with values supplid by configure 
# DEFS gets the `-D' defines that describe what a particular system has
# or doesn't have.

PROG = h5_handler
DODS_ROOT = @dods_relative@
H5_ROOT = @hdf5_path@
# /afs/ncsa/packages/hdf5/5-1.4.0-linux/

INCS = -I$(H5_ROOT)/include @INCS@
DEFS = @DEFS@
CPPFLAGS = @CPPFLAGS@ $(DEFS) $(INCS) 
CFLAGS = @CFLAGS@
CXXFLAGS_DEBUG = -g3 -O0 -Wall -fno-default-inline -fno-defer-pop
CXXFLAGS = @CXXFLAGS@
TEST_COV_FLAGS = -ftest-coverage -fprofile-arcs
TAGS_FLAGS = -i ../dap/TAGS

# Make sure that the core software libraries just built can be found without
# first running make install, but that if `make install' and `make clean' has
# been run those libraries will be found in the `lib' directory.
LDFLAGS = -L. -L$(H5_ROOT)/lib @LDFLAGS@
LIBS = -ldap++ -lhdf5 @LIBS@

# Set the instalation directories; prefix can be set on the command line
# during Makefile construction with `./configure --prefix /my/choice'

prefix = @prefix@
exec_prefix = $(prefix)
bindir = $(exec_prefix)/bin
libdir = $(exec_prefix)/lib
includedir = $(prefix)/include
manext = 1
mandir = $(prefix)/man/man$(manext)

src = $(DODS_ROOT)/src
etcdir = $(DODS_ROOT)/etc

INSTALLMAN = man

SHELL = /bin/sh
srcdir = @srcdir@
version = @VERSION@
basedir = hdf5-dods
dir = $(basedir)-$(version)
host = @host@

COMPONENT_NAME = DODS HDF5 Server
TAR = @TAR@

# testsuite specifics
RUNTEST= runtest
RUNTESTFLAGS= #--all --verbose

# names of key programs

LN_S = @LN_S@
CC = @CC@
CXX = @CXX@
AR = ar
RANLIB = @RANLIB@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
TAGS = etags
STRIP = strip

HDF5SRC = HDF5Array.cc HDF5Byte.cc HDF5Float64.cc HDF5Grid.cc HDF5UInt32.cc \
	HDF5Int32.cc HDF5Sequence.cc HDF5Str.cc HDF5Structure.cc \
	HDF5Url.cc HDF5UInt16.cc HDF5Int16.cc HDF5Float32.cc

HDF5OBJ = HDF5Array.o HDF5Byte.o HDF5Float64.o HDF5Grid.o HDF5Int32.o \
	HDF5Sequence.o HDF5Str.o HDF5Structure.o HDF5Url.o \
	HDF5UInt32.o HDF5UInt16.o HDF5Int16.o HDF5Float32.o

SSRCS = h5_handler.cc h5dds.cc H5Git.c
SRVOBJS = h5dds.o H5Git.o


# Matlab client can be suppressed by a switch to configure.
all: $(PROG)

h5_handler: $(SRVOBJS) $(HDF5OBJ) h5_handler.o
	$(CXX) $(LDFLAGS) -o $@ $^ $(LIBS)	

configure: configure.in $(DODS_ROOT)etc/aclocal.m4
	autoconf --localdir=$(DODS_ROOT)/etc

Makefile: Makefile.in
	if [ -x ./config.status ]; \
	then \
	    ${SHELL} ./config.status; \
	else \
	    ./configure; \
	fi

test-coverage: clean
	$(MAKE) $(MFLAGS) CXXFLAGS="$(CXXFLAGS) $(TEST_COV_FLAGS)" check

# Note that the gcov options -f and -b are useful but sometimes make looking
# at the results of coverage analysis a little taxing. -b reports on all
# branched and -f reports on all functions. The -l -o options summarize on a
# per-file basis. 3/27/98 jhrg
collect-coverage-data:
	(cd test-coverage; \
         cov_dat="coverage-data-`date +%m.%d.%y`"; \
	 touch $$cov_dat; \
	 for f in $(ALLSRCS); do \
	     echo "\n*** Coverage data for $$f ***\n" >> $$cov_dat; \
	     gcov -l -o ../ $$f >> $$cov_dat; \
         done)

install: $(PROG)
	$(INSTALL_PROGRAM) -s $(PROG) $(etcdir)

check: h5-das-check

h5-das-check: h5_das
	$(RUNTEST) $(RUNTESTFLAGS) --tool h5_das --srcdir testsuite

clean:	
	-rm -f *.o *.sum *.log *~ core
	-rm -f $(PROG)

distclean:
	-rm -f *.o *.sum *.log *~ core
	-rm -f $(PROG)
	-rm -f config.status config.log config.cache nph-nc
	-rm -f site.exp config_nc.h lnetcdf/ncconfig.h

.PHONY: depend
depend: 
	@depend@ -m Makefile.in -- $(CPPFLAGS) -- $(SSRCS) $(HDF5SRC)

.PHONY: tar
tar:
	-rm -f config.cache config.log config.status
	cd $(DODS_ROOT)/.. && \
	$(TAR) --exclude 'old' --exclude '.#*' --exclude 'CVS' \
	    --exclude '.snprj*' --exclude '.flc*' --exclude 'Makefile' \
	    --gzip --create --dereference --file DODS-$(dir).tar.gz \
	    DODS/src/$(dir)

# Creates tar files for binary distributions.
#
.PHONY: binary-tar
binary-tar:
	cd $(DODS_ROOT).. && \
        $(TAR) --gzip --create --dereference \
            --file DODS-h5-server-$(version)-$(host).tar.gz \
            DODS/NEWS DODS/etc/README-security \
            DODS/docs/README \
            DODS/etc/h5_das \
            DODS/etc/h5_dds \
            DODS/etc/h5_dods

.PHONY: update-version
update-version: check-version
	@echo "Version is: `cat version.h`"
	if test ! -d ../$(dir); then mv ../$(basedir)* ../$(dir); fi
	if test ! -f $(DODS_ROOT)VERSION; then touch $(DODS_ROOT)VERSION; fi
	$(etcdir)/update-manifest.pl "$(COMPONENT_NAME)" $(version) \
		< $(DODS_ROOT)VERSION > tmp.dods.manifest
	mv tmp.dods.manifest $(DODS_ROOT)VERSION

# Compare the version encoded in this Makefile (set by configure) with the
# version in version.h. The version make variable is set up near the top of
# the Makefile.
.PHONY: check-version
check-version:
	@echo "Checking for version.h and Makefile version match-up"
	@if [ "$(version)" != "`cat version.h`" ]; \
	then \
		echo "You must manually re-run configure!"; \
		exit 1; \
	else \
		echo "Yes, they match."; \
	fi

.PHONY: tags
tags:
	$(TAGS) $(TAGS_FLAGS) *.cc *.h

.SUFFIXES:      .o .cc .c

.c.o:
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -o $@ $<

.cc.o:
	$(CXX) -c $(CXXFLAGS) $(CPPFLAGS) -o $@ $<

# DO NOT DELETE; depend depends on this line.
h5_handler.o: h5_handler.cc config_hdf5.h \
  /usr/local/hdf5/include/H5Gpublic.h /usr/local/hdf5/include/H5public.h \
  /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h \
  /usr/local/hdf5/include/H5Ipublic.h /usr/local/hdf5/include/H5Dpublic.h \
  /usr/local/hdf5/include/H5Fpublic.h /usr/local/hdf5/include/H5Tpublic.h \
  /usr/local/hdf5/include/H5Spublic.h /usr/local/hdf5/include/H5Apublic.h \
  ../../include/debug.h ../../include/cgi_util.h ../../include/DDS.h \
  ../../include/Pix.h ../../include/IteratorAdapter.h \
  ../../include/BaseType.h ../../include/AttrTable.h \
  ../../include/Error.h ../../include/InternalErr.h \
  ../../include/dods-datatypes.h ../../include/DAS.h \
  ../../include/Clause.h ../../include/expr.h ../../include/RValue.h \
  ../../include/ObjectType.h ../../include/EncodingType.h \
  ../../include/DODSFilter.h HDF5Int32.h ../../include/Int32.h \
  HDF5UInt32.h ../../include/UInt32.h HDF5UInt16.h ../../include/UInt16.h \
  HDF5Int16.h ../../include/Int16.h HDF5Byte.h ../../include/Byte.h \
  HDF5Array.h ../../include/Array.h ../../include/dods-limits.h \
  ../../include/Vector.h HDF5Str.h ../../include/Str.h HDF5Float32.h \
  ../../include/Float32.h HDF5Float64.h ../../include/Float64.h \
  HDF5Grid.h ../../include/Grid.h ../../include/Constructor.h common.h
h5dds.o: h5dds.cc config_hdf5.h h5dds.h \
  /usr/local/hdf5/include/H5Gpublic.h /usr/local/hdf5/include/H5public.h \
  /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h \
  /usr/local/hdf5/include/H5Ipublic.h /usr/local/hdf5/include/H5Fpublic.h \
  /usr/local/hdf5/include/H5Tpublic.h /usr/local/hdf5/include/H5Spublic.h \
  /usr/local/hdf5/include/H5Apublic.h ../../include/cgi_util.h \
  ../../include/DDS.h ../../include/Pix.h ../../include/IteratorAdapter.h \
  ../../include/BaseType.h ../../include/AttrTable.h \
  ../../include/Error.h ../../include/InternalErr.h \
  ../../include/dods-datatypes.h ../../include/DAS.h \
  ../../include/Clause.h ../../include/expr.h ../../include/RValue.h \
  ../../include/ObjectType.h ../../include/EncodingType.h \
  ../../include/DODSFilter.h common.h HDF5Int32.h ../../include/Int32.h \
  HDF5UInt32.h ../../include/UInt32.h HDF5UInt16.h ../../include/UInt16.h \
  HDF5Int16.h ../../include/Int16.h HDF5Byte.h ../../include/Byte.h \
  HDF5Array.h ../../include/Array.h ../../include/dods-limits.h \
  ../../include/Vector.h HDF5Str.h ../../include/Str.h HDF5Float32.h \
  ../../include/Float32.h HDF5Float64.h ../../include/Float64.h \
  HDF5Grid.h ../../include/Grid.h ../../include/Constructor.h
H5Git.o: H5Git.c /usr/local/hdf5/include/hdf5.h \
  /usr/local/hdf5/include/H5public.h /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h \
  /usr/local/hdf5/include/H5Ipublic.h /usr/local/hdf5/include/H5Apublic.h \
  /usr/local/hdf5/include/H5ACpublic.h \
  /usr/local/hdf5/include/H5Bpublic.h /usr/local/hdf5/include/H5Dpublic.h \
  /usr/local/hdf5/include/H5Epublic.h /usr/local/hdf5/include/H5Fpublic.h \
  /usr/local/hdf5/include/H5FDpublic.h \
  /usr/local/hdf5/include/H5Gpublic.h \
  /usr/local/hdf5/include/H5HGpublic.h \
  /usr/local/hdf5/include/H5HLpublic.h \
  /usr/local/hdf5/include/H5MMpublic.h \
  /usr/local/hdf5/include/H5Opublic.h /usr/local/hdf5/include/H5Ppublic.h \
  /usr/local/hdf5/include/H5Zpublic.h /usr/local/hdf5/include/H5Rpublic.h \
  /usr/local/hdf5/include/H5Spublic.h /usr/local/hdf5/include/H5Tpublic.h \
  /usr/local/hdf5/include/H5FDcore.h /usr/local/hdf5/include/H5FDfamily.h \
  /usr/local/hdf5/include/H5FDmpio.h /usr/local/hdf5/include/H5FDsec2.h \
  /usr/local/hdf5/include/H5FDstdio.h /usr/local/hdf5/include/H5FDsrb.h \
  /usr/local/hdf5/include/H5FDgass.h /usr/local/hdf5/include/H5FDdpss.h \
  /usr/local/hdf5/include/H5FDstream.h \
  /usr/local/hdf5/include/H5FDmulti.h /usr/local/hdf5/include/H5FDlog.h \
  H5Git.h common.h
HDF5Array.o: HDF5Array.cc config_hdf5.h ../../include/Error.h \
  ../../include/InternalErr.h HDF5Array.h \
  /usr/local/hdf5/include/H5Ipublic.h /usr/local/hdf5/include/H5public.h \
  /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Array.h \
  ../../include/dods-limits.h ../../include/Vector.h \
  ../../include/BaseType.h ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/dods-datatypes.h \
  ../../include/DDS.h ../../include/DAS.h ../../include/Clause.h \
  ../../include/expr.h ../../include/RValue.h HDF5Str.h \
  ../../include/Str.h
HDF5Byte.o: HDF5Byte.cc config_hdf5.h ../../include/InternalErr.h \
  ../../include/Error.h HDF5Byte.h /usr/local/hdf5/include/H5Ipublic.h \
  /usr/local/hdf5/include/H5public.h /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Byte.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDF5Float64.o: HDF5Float64.cc config_hdf5.h ../../include/InternalErr.h \
  ../../include/Error.h HDF5Float64.h /usr/local/hdf5/include/H5Ipublic.h \
  /usr/local/hdf5/include/H5public.h /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Float64.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDF5Grid.o: HDF5Grid.cc config_hdf5.h HDF5Grid.h \
  /usr/local/hdf5/include/H5Ipublic.h /usr/local/hdf5/include/H5public.h \
  /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Grid.h \
  ../../include/Pix.h ../../include/IteratorAdapter.h \
  ../../include/BaseType.h ../../include/AttrTable.h \
  ../../include/Error.h ../../include/InternalErr.h \
  ../../include/dods-datatypes.h ../../include/Constructor.h
HDF5UInt32.o: HDF5UInt32.cc config_hdf5.h ../../include/InternalErr.h \
  ../../include/Error.h HDF5UInt32.h /usr/local/hdf5/include/H5Ipublic.h \
  /usr/local/hdf5/include/H5public.h /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/UInt32.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDF5Int32.o: HDF5Int32.cc config_hdf5.h ../../include/InternalErr.h \
  ../../include/Error.h HDF5Int32.h /usr/local/hdf5/include/H5Ipublic.h \
  /usr/local/hdf5/include/H5public.h /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Int32.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDF5Sequence.o: HDF5Sequence.cc config_hdf5.h HDF5Sequence.h \
  ../../include/Sequence.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Error.h \
  ../../include/InternalErr.h ../../include/dods-datatypes.h \
  ../../include/Constructor.h common.h \
  /usr/local/hdf5/include/H5Ipublic.h /usr/local/hdf5/include/H5public.h \
  /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h
HDF5Str.o: HDF5Str.cc config_hdf5.h ../../include/InternalErr.h \
  ../../include/Error.h HDF5Str.h /usr/local/hdf5/include/H5Ipublic.h \
  /usr/local/hdf5/include/H5public.h /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Str.h \
  ../../include/dods-limits.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/dods-datatypes.h
HDF5Structure.o: HDF5Structure.cc config_hdf5.h HDF5Structure.h \
  /usr/local/hdf5/include/H5Ipublic.h /usr/local/hdf5/include/H5public.h \
  /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Structure.h \
  ../../include/Pix.h ../../include/IteratorAdapter.h \
  ../../include/BaseType.h ../../include/AttrTable.h \
  ../../include/Error.h ../../include/InternalErr.h \
  ../../include/dods-datatypes.h ../../include/Constructor.h \
  ../../include/DDS.h ../../include/DAS.h ../../include/Clause.h \
  ../../include/expr.h ../../include/RValue.h
HDF5Url.o: HDF5Url.cc config_hdf5.h HDF5Url.h \
  /usr/local/hdf5/include/H5Ipublic.h /usr/local/hdf5/include/H5public.h \
  /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Url.h \
  ../../include/dods-limits.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h ../../include/Error.h \
  ../../include/InternalErr.h ../../include/dods-datatypes.h \
  ../../include/Str.h
HDF5UInt16.o: HDF5UInt16.cc config_hdf5.h ../../include/InternalErr.h \
  ../../include/Error.h HDF5UInt16.h /usr/local/hdf5/include/H5Ipublic.h \
  /usr/local/hdf5/include/H5public.h /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/UInt16.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDF5Int16.o: HDF5Int16.cc config_hdf5.h ../../include/InternalErr.h \
  ../../include/Error.h HDF5Int16.h /usr/local/hdf5/include/H5Ipublic.h \
  /usr/local/hdf5/include/H5public.h /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Int16.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
HDF5Float32.o: HDF5Float32.cc config_hdf5.h ../../include/InternalErr.h \
  ../../include/Error.h HDF5Float32.h /usr/local/hdf5/include/H5Ipublic.h \
  /usr/local/hdf5/include/H5public.h /usr/local/hdf5/include/H5pubconf.h \
  /usr/local/hdf5/include/H5api_adpt.h ../../include/Float32.h \
  ../../include/dods-datatypes.h ../../include/BaseType.h \
  ../../include/AttrTable.h ../../include/Pix.h \
  ../../include/IteratorAdapter.h
