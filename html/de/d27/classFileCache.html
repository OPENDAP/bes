<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>bes: FileCache Class Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">bes<span id="projectnumber">&#160;Updated for version 3.21.1</span>
   </div>
   <div id="projectbrief">The Backend Server (BES) is the lower two tiers of the Hyrax data server</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',false,false,'search.php','Search',true);
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('de/d27/classFileCache.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="#friends">Friends</a> &#124;
<a href="../../d7/d10/classFileCache-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">FileCache Class Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Implementation of a caching mechanism for files.  
 <a href="#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>&gt;</code></p>
<div class="dynheader">
Collaboration diagram for FileCache:</div>
<div class="dyncontent">
<div class="center"><img src="../../db/dba/classFileCache__coll__graph.png" border="0" usemap="#aFileCache_coll__map" alt="Collaboration graph"/></div>
<map name="aFileCache_coll__map" id="aFileCache_coll__map">
<area shape="rect" title="Implementation of a caching mechanism for files." alt="" coords="5,5,107,311"/>
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../de/de3/classFileCache_1_1Item.html">Item</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Manage the state of an open file descriptor for a cached item.  <a href="../../de/de3/classFileCache_1_1Item.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d0/d7f/classFileCache_1_1PutItem.html">PutItem</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:ab9a16e41c80ed2cc3428b5aea45e9645" id="r_ab9a16e41c80ed2cc3428b5aea45e9645"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d9/db9/classbool.html">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab9a16e41c80ed2cc3428b5aea45e9645">clear</a> () const</td></tr>
<tr class="memdesc:ab9a16e41c80ed2cc3428b5aea45e9645"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove all files from the cache. Zero the cache info file.  <br /></td></tr>
<tr class="separator:ab9a16e41c80ed2cc3428b5aea45e9645"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9c39a3dc7e42b7e63d2e0c995a388471" id="r_a9c39a3dc7e42b7e63d2e0c995a388471"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d9/db9/classbool.html">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a9c39a3dc7e42b7e63d2e0c995a388471">del</a> (const std::string &amp;key, <a class="el" href="../../d1/da0/classint.html">int</a> lock_type=LOCK_EX|LOCK_NB)</td></tr>
<tr class="memdesc:a9c39a3dc7e42b7e63d2e0c995a388471"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove the item at the given key Remove the key/item. Updates the size recorded in cache_info. Returns false if a number of bad things happen OR if the item could not be locked (i.e., there was an error or the item is in use).  <br /></td></tr>
<tr class="separator:a9c39a3dc7e42b7e63d2e0c995a388471"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9d637277da83c1bd62e78b6ca26cfa26" id="r_a9d637277da83c1bd62e78b6ca26cfa26"><td class="memItemLeft" align="right" valign="top"><a id="a9d637277da83c1bd62e78b6ca26cfa26" name="a9d637277da83c1bd62e78b6ca26cfa26"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>FileCache</b> (const <a class="el" href="../../de/d27/classFileCache.html">FileCache</a> &amp;)=delete</td></tr>
<tr class="separator:a9d637277da83c1bd62e78b6ca26cfa26"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a12c3958b725e30f5cfc3098c2862663e" id="r_a12c3958b725e30f5cfc3098c2862663e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d9/db9/classbool.html">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a12c3958b725e30f5cfc3098c2862663e">get</a> (const std::string &amp;key, <a class="el" href="../../de/de3/classFileCache_1_1Item.html">Item</a> &amp;item, <a class="el" href="../../d1/da0/classint.html">int</a> lock_type=LOCK_SH|LOCK_NB)</td></tr>
<tr class="memdesc:a12c3958b725e30f5cfc3098c2862663e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get a locked (shared) item for a file in the cache.  <br /></td></tr>
<tr class="separator:a12c3958b725e30f5cfc3098c2862663e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab8b01cbf4ce90630cbf725cb96db8f5d" id="r_ab8b01cbf4ce90630cbf725cb96db8f5d"><td class="memItemLeft" align="right" valign="top">virtual <a class="el" href="../../d9/db9/classbool.html">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab8b01cbf4ce90630cbf725cb96db8f5d">initialize</a> (const std::string &amp;cache_dir, long long size, long long purge_size)</td></tr>
<tr class="memdesc:ab8b01cbf4ce90630cbf725cb96db8f5d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the cache.  <br /></td></tr>
<tr class="separator:ab8b01cbf4ce90630cbf725cb96db8f5d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abf50446e2bd7cb702f759fb9e2661966" id="r_abf50446e2bd7cb702f759fb9e2661966"><td class="memItemLeft" align="right" valign="top"><a id="abf50446e2bd7cb702f759fb9e2661966" name="abf50446e2bd7cb702f759fb9e2661966"></a>
<a class="el" href="../../de/d27/classFileCache.html">FileCache</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><b>operator=</b> (const <a class="el" href="../../de/d27/classFileCache.html">FileCache</a> &amp;rhs)=delete</td></tr>
<tr class="separator:abf50446e2bd7cb702f759fb9e2661966"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3c112a16143a6f43feea5496cb0ba2d3" id="r_a3c112a16143a6f43feea5496cb0ba2d3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d9/db9/classbool.html">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a3c112a16143a6f43feea5496cb0ba2d3">purge</a> ()</td></tr>
<tr class="memdesc:a3c112a16143a6f43feea5496cb0ba2d3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Purge the lest recently used items from the cache. The <a class="el" href="#a3c112a16143a6f43feea5496cb0ba2d3" title="Purge the lest recently used items from the cache. The purge() method for FileCache is public....">purge()</a> method for <a class="el" href="../../de/d27/classFileCache.html" title="Implementation of a caching mechanism for files.">FileCache</a> is public. It is the user's job to call purge. The idea behind this is that user code can decide if purge needs to be called on every put, every Nth put or not at all. Note that <a class="el" href="#a3c112a16143a6f43feea5496cb0ba2d3" title="Purge the lest recently used items from the cache. The purge() method for FileCache is public....">purge()</a> (often) does nothing more than compare the size recorded in the cache_info file (updated on every <a class="el" href="#af163d0f11558d38d28328c62abf373ce" title="Put an item in the cache Put the contents of a file in the cache, referenced by the given key....">put()</a>) with the configured max cache size.  <br /></td></tr>
<tr class="separator:a3c112a16143a6f43feea5496cb0ba2d3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af163d0f11558d38d28328c62abf373ce" id="r_af163d0f11558d38d28328c62abf373ce"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d9/db9/classbool.html">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af163d0f11558d38d28328c62abf373ce">put</a> (const std::string &amp;key, const std::string &amp;file_name)</td></tr>
<tr class="memdesc:af163d0f11558d38d28328c62abf373ce"><td class="mdescLeft">&#160;</td><td class="mdescRight">Put an item in the cache Put the contents of a file in the cache, referenced by the given key. The item is unlocked when this method returns and cache_info file is updated.  <br /></td></tr>
<tr class="separator:af163d0f11558d38d28328c62abf373ce"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a683bfd846c38991f4383b1d8ae123eb1" id="r_a683bfd846c38991f4383b1d8ae123eb1"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d9/db9/classbool.html">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a683bfd846c38991f4383b1d8ae123eb1">put</a> (const std::string &amp;key, <a class="el" href="../../d0/d7f/classFileCache_1_1PutItem.html">PutItem</a> &amp;item)</td></tr>
<tr class="memdesc:a683bfd846c38991f4383b1d8ae123eb1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Put an item in the cache Put an item in the cache by returning an open and lock file descriptor to the item. The called can write directly to the item, rewind the descriptor and read from it and then close the file descriptor to release the Exclusive lock.  <br /></td></tr>
<tr class="separator:a683bfd846c38991f4383b1d8ae123eb1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa845f48b517a2497d4ad62e5eba8dd0" id="r_afa845f48b517a2497d4ad62e5eba8dd0"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d9/db9/classbool.html">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#afa845f48b517a2497d4ad62e5eba8dd0">put_data</a> (const std::string &amp;key, const std::string &amp;data)</td></tr>
<tr class="separator:afa845f48b517a2497d4ad62e5eba8dd0"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-static-methods" name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a798fc536ba376033793b4341a8f0f877" id="r_a798fc536ba376033793b4341a8f0f877"><td class="memItemLeft" align="right" valign="top">static std::string&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a798fc536ba376033793b4341a8f0f877">hash_key</a> (const std::string &amp;key, <a class="el" href="../../d9/db9/classbool.html">bool</a> log_it=false)</td></tr>
<tr class="memdesc:a798fc536ba376033793b4341a8f0f877"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return a SHA256 hash of the given key.  <br /></td></tr>
<tr class="separator:a798fc536ba376033793b4341a8f0f877"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="friends" name="friends"></a>
Friends</h2></td></tr>
<tr class="memitem:aebe528a6d046273c415beef453c95c7a" id="r_aebe528a6d046273c415beef453c95c7a"><td class="memItemLeft" align="right" valign="top">class&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aebe528a6d046273c415beef453c95c7a">FileCacheTest</a></td></tr>
<tr class="separator:aebe528a6d046273c415beef453c95c7a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation of a caching mechanism for files. </p>
<p>This cache uses simple advisory locking found on most modern unix file systems. It was originally designed to hold the decompressed versions of compressed files.</p>
<p>Compressed files are uncompressed and stored in a cache where they can be used over and over until removed from the cache. Several processes can share the cache with each reading from files. At the same time, new files can be added and the cache can be purged, without disrupting the existing read operations.</p>
<p>How it works: Before a file is added to the cache, the cache is locked - no other processes can add, read or remove files. Once a file has been added, the cache size is updated cache is unlocked. Unlike other caches, this implementation does not automatically purge entries when the size becomes too large. It is up to the client code to call the <a class="el" href="#a3c112a16143a6f43feea5496cb0ba2d3" title="Purge the lest recently used items from the cache. The purge() method for FileCache is public....">purge()</a> method when the size is at the maximum size.</p>
<p>When a process tries to get a file that is already in the cache, the entire cache is locked. If the file is present, a shared read lock on the cached file is obtained and the cache is unlocked.</p>
<p>For the <a class="el" href="#af163d0f11558d38d28328c62abf373ce" title="Put an item in the cache Put the contents of a file in the cache, referenced by the given key....">put()</a>, <a class="el" href="#a12c3958b725e30f5cfc3098c2862663e" title="Get a locked (shared) item for a file in the cache.">get()</a>, and <a class="el" href="#a9c39a3dc7e42b7e63d2e0c995a388471" title="Remove the item at the given key Remove the key/item. Updates the size recorded in cache_info....">del()</a> methods, the client code must manage the mapping between the things in the cache and the keys.</p>
<p>This is the Nth rewrite of the original BES 'uncompress cache' and it now supplies a much simpler interface: <a class="el" href="#ab8b01cbf4ce90630cbf725cb96db8f5d" title="Initialize the cache.">initialize()</a>, <a class="el" href="#af163d0f11558d38d28328c62abf373ce" title="Put an item in the cache Put the contents of a file in the cache, referenced by the given key....">put()</a>, <a class="el" href="#a12c3958b725e30f5cfc3098c2862663e" title="Get a locked (shared) item for a file in the cache.">get()</a>, <a class="el" href="#a9c39a3dc7e42b7e63d2e0c995a388471" title="Remove the item at the given key Remove the key/item. Updates the size recorded in cache_info....">del()</a>, and <a class="el" href="#a3c112a16143a6f43feea5496cb0ba2d3" title="Purge the lest recently used items from the cache. The purge() method for FileCache is public....">purge()</a>. The constructor for <a class="el" href="../../de/d27/classFileCache.html" title="Implementation of a caching mechanism for files.">FileCache</a> no longer initializes the cache, use the named method for that. The put(key, source file) method locks the cache and copies the contents of 'source file' into a new file that is named 'key.' The get(key, item) method opens the file named 'key' and returns an instance of <a class="el" href="../../de/de3/classFileCache_1_1Item.html" title="Manage the state of an open file descriptor for a cached item.">FileCache::Item</a> that holds the locked (shared, using flock(2)) file. Use close(item.get_fd()) to release the lock and close the file. The del(key) method deletes the file if it can get an exclusive lock on the file. The <a class="el" href="#a9c39a3dc7e42b7e63d2e0c995a388471" title="Remove the item at the given key Remove the key/item. Updates the size recorded in cache_info....">del()</a> method is the only method that uses a non-blocking lock on a file. If can be forced to use a blocking lock using an optional second argument. There is a second put(key, PutItem) method that returns a <a class="el" href="../../d0/d7f/classFileCache_1_1PutItem.html">PutItem</a> instance that holds an open, locked, file descriptor. The <a class="el" href="../../d0/d7f/classFileCache_1_1PutItem.html">PutItem</a> dtor updates the cache_info file. This method exists to allow the caller to write directly to the file and then close the file descriptor to release the lock.</p>
<dl class="section note"><dt>Note</dt><dd>The locking mechanism uses Unix flock(2) and so is <em>per file</em>. Using flock(2) instead of fcntl(2) means that the locking is thread-safe. On older linux kernels (&lt; 2.6.12) flock(2) does not work with NFSv4. Based on stackoverflow<a href="../../stackoverflow.com/questions/53177938/is-it-safe-to-use-flock-on-aws-efs-to-emulate-a-critical-section">0</a>, it should work with an AWS EFS volume and newer NFS implementations. (YMMV). </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00122">122</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="aa9cbe883a0c0a4e0581e79e016459990" name="aa9cbe883a0c0a4e0581e79e016459990"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa9cbe883a0c0a4e0581e79e016459990">&#9670;&#160;</a></span>~FileCache()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">virtual FileCache::~FileCache </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel virtual">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00399">399</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="ab9a16e41c80ed2cc3428b5aea45e9645" name="ab9a16e41c80ed2cc3428b5aea45e9645"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab9a16e41c80ed2cc3428b5aea45e9645">&#9670;&#160;</a></span>clear()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/db9/classbool.html">bool</a> FileCache::clear </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Remove all files from the cache. Zero the cache info file. </p>
<dl class="section return"><dt>Returns</dt><dd>false if the cache directory could not be opened or a file in the cache could not be removed, true otherwise. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00646">646</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<a id="a9c39a3dc7e42b7e63d2e0c995a388471" name="a9c39a3dc7e42b7e63d2e0c995a388471"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9c39a3dc7e42b7e63d2e0c995a388471">&#9670;&#160;</a></span>del()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/db9/classbool.html">bool</a> FileCache::del </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>key</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d1/da0/classint.html">int</a></td>          <td class="paramname"><span class="paramname"><em>lock_type</em></span><span class="paramdefsep"> = </span><span class="paramdefval">LOCK_EX&#160;|&#160;LOCK_NB</span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Remove the item at the given key Remove the key/item. Updates the size recorded in cache_info. Returns false if a number of bad things happen OR if the item could not be locked (i.e., there was an error or the item is in use). </p>
<dl class="section note"><dt>Note</dt><dd>This is not used by <a class="el" href="#a3c112a16143a6f43feea5496cb0ba2d3" title="Purge the lest recently used items from the cache. The purge() method for FileCache is public....">purge()</a> </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">key</td><td>The item key </td></tr>
    <tr><td class="paramname">lock_type</td><td>The kind of lock to use; Exclusive Non-blocking by default. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>True if the key/item is deleted, false if not. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00611">611</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<a id="a12c3958b725e30f5cfc3098c2862663e" name="a12c3958b725e30f5cfc3098c2862663e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a12c3958b725e30f5cfc3098c2862663e">&#9670;&#160;</a></span>get()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/db9/classbool.html">bool</a> FileCache::get </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>key</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../de/de3/classFileCache_1_1Item.html">Item</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>item</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d1/da0/classint.html">int</a></td>          <td class="paramname"><span class="paramname"><em>lock_type</em></span><span class="paramdefsep"> = </span><span class="paramdefval">LOCK_SH&#160;|&#160;LOCK_NB</span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Get a locked (shared) item for a file in the cache. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">key</td><td>The key to the cached item </td></tr>
    <tr><td class="paramname">item</td><td>A reference to an <a class="el" href="../../de/de3/classFileCache_1_1Item.html" title="Manage the state of an open file descriptor for a cached item.">Item</a> - a value-result parameter. Release the lock by closing the file. </td></tr>
    <tr><td class="paramname">lock_type</td><td>By default, get a shared non-blocking lock. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>True if the item was found and locked, false otherwise </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00574">574</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<a id="a798fc536ba376033793b4341a8f0f877" name="a798fc536ba376033793b4341a8f0f877"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a798fc536ba376033793b4341a8f0f877">&#9670;&#160;</a></span>hash_key()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static std::string FileCache::hash_key </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>key</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d9/db9/classbool.html">bool</a></td>          <td class="paramname"><span class="paramname"><em>log_it</em></span><span class="paramdefsep"> = </span><span class="paramdefval">false</span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Return a SHA256 hash of the given key. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">key</td><td>The key to has </td></tr>
    <tr><td class="paramname">log_it</td><td>If true, write an info message to the bes log so it's easier to track the key --&gt; hash mapping. False by default. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The SHA256 hash of the key. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00314">314</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<a id="ab8b01cbf4ce90630cbf725cb96db8f5d" name="ab8b01cbf4ce90630cbf725cb96db8f5d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab8b01cbf4ce90630cbf725cb96db8f5d">&#9670;&#160;</a></span>initialize()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">virtual <a class="el" href="../../d9/db9/classbool.html">bool</a> FileCache::initialize </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>cache_dir</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long long</td>          <td class="paramname"><span class="paramname"><em>size</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long long</td>          <td class="paramname"><span class="paramname"><em>purge_size</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span><span class="mlabel virtual">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialize the cache. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cache_dir</td><td>Directory on some filesystem where the cache will be stored. This directory is made if it does not exist. </td></tr>
    <tr><td class="paramname">size</td><td>Allow this many bytes in the cache </td></tr>
    <tr><td class="paramname">purge_size</td><td>When purging, remove items until this many bytes remain. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>False if the cache object could not be initialized, true otherwise. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00413">413</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<a id="a3c112a16143a6f43feea5496cb0ba2d3" name="a3c112a16143a6f43feea5496cb0ba2d3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3c112a16143a6f43feea5496cb0ba2d3">&#9670;&#160;</a></span>purge()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/db9/classbool.html">bool</a> FileCache::purge </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Purge the lest recently used items from the cache. The <a class="el" href="#a3c112a16143a6f43feea5496cb0ba2d3" title="Purge the lest recently used items from the cache. The purge() method for FileCache is public....">purge()</a> method for <a class="el" href="../../de/d27/classFileCache.html" title="Implementation of a caching mechanism for files.">FileCache</a> is public. It is the user's job to call purge. The idea behind this is that user code can decide if purge needs to be called on every put, every Nth put or not at all. Note that <a class="el" href="#a3c112a16143a6f43feea5496cb0ba2d3" title="Purge the lest recently used items from the cache. The purge() method for FileCache is public....">purge()</a> (often) does nothing more than compare the size recorded in the cache_info file (updated on every <a class="el" href="#af163d0f11558d38d28328c62abf373ce" title="Put an item in the cache Put the contents of a file in the cache, referenced by the given key....">put()</a>) with the configured max cache size. </p>
<dl class="section return"><dt>Returns</dt><dd>True if the purge operation encountered no errors, false if failures were found. Note that if an entry cannot be removed, that is not an error because the item might be locked since it's in use. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00678">678</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<a id="af163d0f11558d38d28328c62abf373ce" name="af163d0f11558d38d28328c62abf373ce"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af163d0f11558d38d28328c62abf373ce">&#9670;&#160;</a></span>put() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/db9/classbool.html">bool</a> FileCache::put </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>key</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>file_name</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Put an item in the cache Put the contents of a file in the cache, referenced by the given key. The item is unlocked when this method returns and cache_info file is updated. </p>
<dl class="section note"><dt>Note</dt><dd>This method <em>copies</em> the file contents to cache it. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">key</td><td>The key used to access the file </td></tr>
    <tr><td class="paramname">file_name</td><td>The name of the file that will be cached. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>True if the data are cached, false otherwise. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00450">450</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<a id="a683bfd846c38991f4383b1d8ae123eb1" name="a683bfd846c38991f4383b1d8ae123eb1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a683bfd846c38991f4383b1d8ae123eb1">&#9670;&#160;</a></span>put() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/db9/classbool.html">bool</a> FileCache::put </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>key</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d0/d7f/classFileCache_1_1PutItem.html">PutItem</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>item</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Put an item in the cache Put an item in the cache by returning an open and lock file descriptor to the item. The called can write directly to the item, rewind the descriptor and read from it and then close the file descriptor to release the Exclusive lock. </p>
<dl class="section note"><dt>Note</dt><dd>When the <a class="el" href="../../d0/d7f/classFileCache_1_1PutItem.html">PutItem</a> goes out of scope, the cache_info file is updated. Make <em>sure</em> no operation that locks the cache gets called before the <a class="el" href="../../d0/d7f/classFileCache_1_1PutItem.html">PutItem</a> lock is removed, otherwise there will be a deadlock. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">key</td><td>The key that can be used to access the file </td></tr>
    <tr><td class="paramname">item</td><td>A value-result parameter than is a reference to a <a class="el" href="../../d0/d7f/classFileCache_1_1PutItem.html">PutItem</a> instance. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>True if the <a class="el" href="../../d0/d7f/classFileCache_1_1PutItem.html">PutItem</a> holds an open, locked, file descriptor, otherwise false. </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00544">544</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<a id="afa845f48b517a2497d4ad62e5eba8dd0" name="afa845f48b517a2497d4ad62e5eba8dd0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afa845f48b517a2497d4ad62e5eba8dd0">&#9670;&#160;</a></span>put_data()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/db9/classbool.html">bool</a> FileCache::put_data </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>key</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;</td>          <td class="paramname"><span class="paramname"><em>data</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00496">496</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<h2 class="groupheader">Friends And Related Symbol Documentation</h2>
<a id="aebe528a6d046273c415beef453c95c7a" name="aebe528a6d046273c415beef453c95c7a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aebe528a6d046273c415beef453c95c7a">&#9670;&#160;</a></span>FileCacheTest</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">friend class FileCacheTest</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel friend">friend</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../da/d07/FileCache_8h_source.html#l00304">304</a> of file <a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="../../da/d07/FileCache_8h_source.html">FileCache.h</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../de/d27/classFileCache.html">FileCache</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
