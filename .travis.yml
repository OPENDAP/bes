# -*- shell-script -*-
#
# Initial Travic-CI control file. 6.5.15 jhrg

# Use the docker container-based build systems
sudo: false

cache:
  directories:
  - $HOME/deps

language: cpp

compiler:
  - gcc
  # - clang

# Whitelist; assume tags for releases use the familiar dot notation
# Building a tag will trigger a deployment; see the 'deploy' section
# down below
branches:
  only:
    - master
    - coverity_scan
    - /^*_travis/
    - /^*-[0-9]+\.[0-9]+\.[0-9]+/

# Only use gcc for Coverity builds
matrix:
  exclude:
    - compiler: clang
    - env: COVERITY_SCAN_BRANCH=1

addons:
  coverity_scan:
    project:
      name: "OPENDAP/bes"
    notification_email: jgallagher@opendap.org
    build_command: "make -j7"
    branch_pattern: coverity_scan
  apt:
    packages:
      - uuid-dev
      - libxml2-dev
      - libcurl4-openssl-dev
      - libcppunit-dev
      - libnetcdf-dev
      - libhdf4-dev
      - libhdfeos-dev
      # Depends on libhdf4-alt-dev, libcurl4-gnutls-dev, libdap-dev but 
      # those "won't be installed" jhrg 8/7/15- libgdal-dev
      - libopenjpeg-dev
      - libcfitsio3-dev
      - libicu-dev

# Use this to prepare the system to install prerequisites or
# dependencies
# before_install:
  
# Use this to install any prerequisites or dependencies necessary to
# run your build. This script builds bison-3, libdap and hdf5 - these
# are available via ubuntu apt-get, but we need newer versions than
# Ubuntu 12 has.
install:
  - export PATH=$HOME/deps/bin:$PATH
  - bash ./install_bes_source_deps.sh
  - ls -R $HOME/deps

# Use this to prepare your build for testing e.g. copy database
# configurations, environment variables, etc.
before_script:
  - ln -s configure_modules.ac configure.ac
  - autoreconf --force --install --verbose
  # Want the hdf5 handler build to find the hdf5 lib headers from the
  # source tarball we just built.
  - ./configure --prefix=$HOME/build CPPFLAGS=-I$HOME/deps/include

# All commands must exit with code 0 on success. Anything else is
# considered failure.
script:
  - if [ ${COVERITY_SCAN_BRANCH} != 1 ]; then make -j7 && make install; make check -j7; fi

# && make check -j7 -k

env:
  global:
  # TRAVIS_AT_OO
  # Made using: travis encrypt TRAVIS_AT_OO=<secret> -r OPENDAP/bes
  # where -r <...> is the name of the travis repo from our Travis landing page.
  - secure: "TukKQWS5cIh0D2Py3K4HFs9R1hHzU63XQ7jcv0GsiVD73Lpx/ZtejoCPkIs++VQWUVT8z7iXZ5cJ9MMGTA8oqz+tAOTDFc4CJCCOyetJlkxvnl8+3fm8j8ipwrDj/uznh45NrhfFNnAB4Pf1OoEWEgDjLA9N434J1eK3w+CFNz8="

after_failure:
  - ./get_autotest_logs.sh /tmp/bes-autotest-${TRAVIS_BUILD_NUMBER}-logs.tar.gz
  - ls -lh /tmp/bes-autotest-${TRAVIS_BUILD_NUMBER}-logs.tar.gz
  - sshpass -p ${TRAVIS_AT_OO} scp /tmp/bes-autotest-${TRAVIS_BUILD_NUMBER}-logs.tar.gz travis@www.opendap.org:
